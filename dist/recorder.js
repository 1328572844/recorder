/*!
 * 
 * js-audio-recorder - js audio recorder plugin
 * 
 * @version v0.5.3
 * @homepage https://github.com/2fps/recorder
 * @author 2fps <echoweb@126.com> (https://www.zhuyuntao.cn)
 * @license MIT
 *         
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Recorder=e():t.Recorder=e()}(this,function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),o=n(2),r=n(3),s=function(){function t(t){void 0===t&&(t={}),this.isplaying=!1,this.lBuffer=[],this.rBuffer=[],this.tempPCM=[],this.inputSampleBits=16,this.offset=0,this.fileSize=0;var e,n=new(window.AudioContext||window.webkitAudioContext);this.inputSampleRate=n.sampleRate,this.config={sampleBits:~[8,16].indexOf(t.sampleBits)?t.sampleBits:16,sampleRate:~[11025,16e3,22050,24e3,44100,48e3].indexOf(t.sampleRate)?t.sampleRate:this.inputSampleRate,numChannels:~[1,2].indexOf(t.numChannels)?t.numChannels:1,compiling:!!t.compiling||!1},this.outputSampleRate=this.config.sampleRate,this.oututSampleBits=this.config.sampleBits,this.littleEdian=(e=new ArrayBuffer(2),new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]),this.initUserMedia()}return t.prototype.initRecorder=function(){var t=this;this.context&&this.destroy(),this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048;var e=this.context.createScriptProcessor||this.context.createJavaScriptNode;this.recorder=e.apply(this.context,[4096,this.config.numChannels,this.config.numChannels]),this.recorder.onaudioprocess=function(e){if(t.isrecording&&!t.ispause){var n,i=e.inputBuffer.getChannelData(0),o=null;if(t.lBuffer.push(new Float32Array(i)),t.size+=i.length,2===t.config.numChannels&&(o=e.inputBuffer.getChannelData(1),t.rBuffer.push(new Float32Array(o)),t.size+=o.length),t.config.compiling){var r=t.transformIntoPCM(i,o);t.tempPCM.push(r),t.fileSize=r.byteLength*t.tempPCM.length}else t.fileSize=Math.floor(t.size/Math.max(t.inputSampleRate/t.outputSampleRate,1))*(t.oututSampleBits/8);n=100*Math.max.apply(Math,i),t.duration+=4096/t.inputSampleRate,t.onprocess&&t.onprocess(t.duration),t.onprogress&&t.onprogress({duration:t.duration,fileSize:t.fileSize,vol:n,data:t.tempPCM})}}},t.prototype.start=function(){var t=this;if(!this.isrecording)return this.clear(),this.initRecorder(),this.isrecording=!0,navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){t.audioInput=t.context.createMediaStreamSource(e),t.stream=e}).then(function(){t.audioInput.connect(t.analyser),t.analyser.connect(t.recorder),t.recorder.connect(t.context.destination)})},t.prototype.pause=function(){this.isrecording&&!this.ispause&&(this.ispause=!0,this.recorder.disconnect())},t.prototype.resume=function(){this.isrecording&&this.ispause&&(this.ispause=!1,this.audioInput&&this.audioInput.connect(this.analyser),this.analyser.connect(this.recorder),this.recorder.connect(this.context.destination))},t.prototype.stop=function(){this.isrecording=!1,this.audioInput&&this.audioInput.disconnect(),this.recorder.disconnect()},t.prototype.play=function(){this.stop(),this.source&&this.source.stop(),this.isplaying=!0,this.onplay(),r.default.addPlayEnd(this.onplayend),r.default.play(this.getWAV().buffer)},t.prototype.pausePlay=function(){!this.isrecording&&this.isplaying&&(this.isplaying=!1,this.onpauseplay(),r.default.pausePlay())},t.prototype.resumePlay=function(){this.isrecording||this.isplaying||(this.isplaying=!0,this.onresumeplay(),r.default.resumePlay())},t.prototype.stopPlay=function(){this.isrecording||(this.isplaying=!1,this.onstopplay(),r.default.stopPlay())},t.prototype.getWholeData=function(){return this.tempPCM},t.prototype.getNextData=function(){var t=this.tempPCM.length,e=this.tempPCM.slice(this.offset);return this.offset=t,e},t.prototype.getRecordAnalyseData=function(){if(this.ispause)return this.prevDomainData;var t=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(t),this.prevDomainData=t},t.prototype.getPlayAnalyseData=function(){return this.getRecordAnalyseData()},t.prototype.initUserMedia=function(){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(t){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise(function(n,i){e.call(navigator,t,n,i)}):Promise.reject(new Error("浏览器不支持 getUserMedia !"))})},t.prototype.getPCM=function(){if(this.tempPCM.length){var t=new ArrayBuffer(this.tempPCM.length*this.tempPCM[0].byteLength),e=new DataView(t),n=0;this.tempPCM.forEach(function(t){for(var i=0,o=t.byteLength;i<o;++i)e.setInt8(n,t.getInt8(i)),n++}),this.PCM=e,this.tempPCM=[]}if(this.PCM)return this.PCM;var i=this.flat();return i=o.compress(i,this.inputSampleRate,this.outputSampleRate),this.PCM=o.encodePCM(i,this.oututSampleBits,this.littleEdian)},t.prototype.getPCMBlob=function(){return this.stop(),new Blob([this.getPCM()])},t.prototype.downloadPCM=function(t){void 0===t&&(t="recorder");var e=this.getPCMBlob();i.downloadPCM(e,t)},t.prototype.getWAV=function(){var t=this.getPCM();return o.encodeWAV(t,this.inputSampleRate,this.outputSampleRate,this.config.numChannels,this.oututSampleBits,this.littleEdian)},t.prototype.getWAVBlob=function(){return this.stop(),new Blob([this.getWAV()],{type:"audio/wav"})},t.prototype.downloadWAV=function(t){void 0===t&&(t="recorder");var e=this.getWAVBlob();i.downloadWAV(e,t)},t.prototype.transformIntoPCM=function(t,e){var n=new Float32Array(t),i=new Float32Array(e),r=o.compress({left:n,right:i},this.inputSampleRate,this.outputSampleRate);return o.encodePCM(r,this.oututSampleBits,this.littleEdian)},t.prototype.destroy=function(){return this.stopStream(),this.closeAudioContext()},t.prototype.stopStream=function(){this.stream&&this.stream.getTracks&&(this.stream.getTracks().forEach(function(t){return t.stop()}),this.stream=null)},t.prototype.closeAudioContext=function(){return this.context.close?this.context.close():new Promise(function(t){t()})},t.prototype.clear=function(){this.lBuffer.length=0,this.rBuffer.length=0,this.size=0,this.fileSize=0,this.PCM=null,this.audioInput=null,this.duration=0,this.ispause=!1,this.isplaying=!1,this.source&&(this.source.stop(),this.source=null)},t.prototype.flat=function(){var t=null,e=new Float32Array(0);1===this.config.numChannels?t=new Float32Array(this.size):(t=new Float32Array(this.size/2),e=new Float32Array(this.size/2));for(var n=0,i=0;i<this.lBuffer.length;i++)t.set(this.lBuffer[i],n),n+=this.lBuffer[i].length;n=0;for(i=0;i<this.rBuffer.length;i++)e.set(this.rBuffer[i],n),n+=this.rBuffer[i].length;return{left:t,right:e}},t}();e.default=s},function(t,e,n){"use strict";function i(t,e,n){var i=document.createElement("a");i.href=window.URL.createObjectURL(t),i.download=e+"."+n,i.click()}Object.defineProperty(e,"__esModule",{value:!0}),e.downloadWAV=function(t,e){void 0===e&&(e="recorder"),i(t,e,"wav")},e.downloadPCM=function(t,e){void 0===e&&(e="recorder"),i(t,e,"pcm")}},function(t,e,n){"use strict";function i(t,e,n){for(var i=0;i<n.length;i++)t.setUint8(e+i,n.charCodeAt(i))}Object.defineProperty(e,"__esModule",{value:!0}),e.compress=function(t,e,n){for(var i=e/n,o=Math.max(i,1),r=t.left,s=t.right,a=Math.floor((r.length+s.length)/i),u=new Float32Array(a),l=0,c=0;l<a;){var p=Math.floor(c);u[l]=r[p],l++,s.length&&(u[l]=s[p],l++),c+=o}return u},e.encodePCM=function(t,e,n){void 0===n&&(n=!0);var i=0,o=t.length*(e/8),r=new ArrayBuffer(o),s=new DataView(r);if(8===e)for(var a=0;a<t.length;a++,i++){var u=(l=Math.max(-1,Math.min(1,t[a])))<0?128*l:127*l;u=+u+128,s.setInt8(i,u)}else for(a=0;a<t.length;a++,i+=2){var l=Math.max(-1,Math.min(1,t[a]));s.setInt16(i,l<0?32768*l:32767*l,n)}return s},e.encodeWAV=function(t,e,n,o,r,s){void 0===s&&(s=!0);var a=n>e?e:n,u=r,l=new ArrayBuffer(44+t.byteLength),c=new DataView(l),p=o,f=0;i(c,f,"RIFF"),f+=4,c.setUint32(f,36+t.byteLength,s),i(c,f+=4,"WAVE"),i(c,f+=4,"fmt "),f+=4,c.setUint32(f,16,s),f+=4,c.setUint16(f,1,s),f+=2,c.setUint16(f,p,s),f+=2,c.setUint32(f,a,s),f+=4,c.setUint32(f,p*a*(u/8),s),f+=4,c.setUint16(f,p*(u/8),s),f+=2,c.setUint16(f,u,s),i(c,f+=2,"data"),f+=4,c.setUint32(f,t.byteLength,s),f+=4;for(var h=0;h<t.byteLength;)c.setUint8(f,t.getUint8(h)),f++,h++;return c}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(4),o=null,r=0,s=0,a=null,u=null,l=null,c=!1,p=function(){};function f(){return a.decodeAudioData(l.slice(0),function(t){(o=a.createBufferSource()).onended=function(){p()},o.buffer=t,o.connect(u),u.connect(a.destination),o.start(0,r),s=a.currentTime},function(t){i.throwError(t)})}var h=function(){function t(){}return t.play=function(t){return c||(a=new(window.AudioContext||window.webkitAudioContext),u=a.createAnalyser(),c=!0),this.stopPlay(),l=t,f()},t.pausePlay=function(){o&&o.disconnect(),r+=a.currentTime-s},t.resumePlay=function(){return f()},t.stopPlay=function(){r=0,l=null,o&&o.stop()},t.addPlayEnd=function(t){void 0===t&&(t=function(){}),p=t},t}();e.default=h},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.throwError=function(t){throw new Error(t)}}]).default});
//# sourceMappingURL=recorder.js.map